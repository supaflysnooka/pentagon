#Copyright 2017 Reactive Ops Inc.
#
#Licensed under the Apache License, Version 2.0 (the “License”);
#you may not use this file except in compliance with the License.
#You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
#Unless required by applicable law or agreed to in writing, software
#distributed under the License is distributed on an “AS IS” BASIS,
#WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#See the License for the specific language governing permissions and
#limitations under the License.


version: 2

jobs:
  build:
    machine: true
    environment:
      PROJECT_NAME: pentaton-integration
    working_directory: ~/pentagon
    steps:
      - checkout
      - run:
          name: Install Pentagon
          command: |
            sudo pip install -e .
      - run:
          name: Unit Tests
          command: |
            sudo pip install -r ${HOME}/pentagon/lib/tests/requirements.txt
            nosetests
      - run:
          name: Build Docker Image
          command: |
            docker build -t pentagon .
      - run:
          name: Test Start Project
          command: |
            mkdir ${PROJECT_NAME}-infrastructure
            docker run -v `pwd`/${PROJECT_NAME}-infrastructure:/${PROJECT_NAME}-infrastructure --rm pentagon pentagon start-project ${PROJECT_NAME} --aws-access-key ${AWS_ACCESS_KEY} --aws-secret-key ${AWS_SECRET_KEY} --aws-default-region ap-northeast-1 --aws-availability-zones="ap-northeast-1a, ap-northeast-1c" --dns-zone="integration.hillghost.com"
            # cd ${PROJECT_NAME}
            # source config/local/env-vars.sh
            # pip install -r requirements.txt
            # cd config/local/
            # bash local-config-init
            ls
      